// 初始化示例
const tcb = require('./');
const assert = require('assert')

// 初始化资源
// 云函数下不需要secretId和secretKey。
// env如果不指定将使用默认环境
tcb.init({
    secretId: 'AKIDmaXZoANOGFEAIaTU5127Id3WsN68p3WZ',
    secretKey: 'XAulILBGUl9cDtkdbcit7ZBsnxCTtRTZ',
    env: 'test-e48fe1'
});

const db = tcb.database();
(async () => {
    // {
    //     let result = await tcb.callFunction({
    //         name: "test",
    //         data: {
    //             a: 1,
    //             b: 2
    //         }
    //     })
    //     console.log(result)
    // }

    // {
    //     let result = await db.collection('counters').where({ _id: db.command.eq('W8Q83N2AWotkfKzE') }).get()
    //     assert.strictEqual(result.data[0]._id, 'W8Q83N2AWotkfKzE')
    // }

    // {
    //     let result = await db.collection('counters').where({ _id: db.command.eq('W8Q83N2AWotkfKzE') }).count()
    //     assert.strictEqual(result.total, 1)
    // }

    // {
    //     // 增
    //     let id = (await db.collection('counters').add({
    //         foo: 123
    //     })).id
    //     console.log(id)

    // 查
    // let item = await db.collection('counters').where({ _id: db.command.regex('\\d') }).skip(0).get()
    // console.log(item)
    // // assert.strictEqual(item.data[0].foo, 123)
    // let count = await db.collection('counters').where({ _id: db.command.eq(id) }).count()
    // assert.strictEqual(count.total, 1)

    //     // 改
    //     await db.collection('counters').where({ _id: db.command.eq(id) }).update({
    //         foo: 666
    //     })
    //     let item2 = await db.collection('counters').where({ _id: db.command.eq(id) }).get()
    //     assert.strictEqual(item2.data[0].foo, 666)

    //     // 删
    //     await db.collection('counters').where({ _id: db.command.eq(id) }).remove()
    // }

    {
        // 增
        let id = (await db.collection('counters').add({
            a: { b: { c: [1, 2, 3], d: 123 } },
            count: 1,
            foo: [0, 1, 2, 3, 4, 5, 6, 7, 8, 9]
        })).id

        // await db.collection('counters').doc(id).update({
        //     a: { b: { c: 666 } },
        //     foo: db.command.pop()
        // })

        // // 查
        // let item2 = await db.collection('counters').where({ _id: id }).get()
        // console.log(item2.data[0])

        // await db.collection('counters').doc(id).update({
        //     a: { b: { c: 666 } },
        //     foo: db.command.pop()
        // })

        let res = await db.collection('counters').doc(id).update({
            a: {
                b: { c: db.command.push([9, 9, 9]), d: db.command.inc(1) },
            }
        })
        console.log(res)

        // 查
        let item2 = await db.collection('counters').where({ _id: id }).get()
        console.log(JSON.stringify(item2.data[0]))
    }

    // {
    //     let ID = '312312312'
    //     let id = (await db.collection('counters').doc(ID).set({
    //         foo: 123
    //     })).upsertedId || ID
    //     console.log(id)

    //     await db.collection('counters').doc(id).update({
    //         foo: 666
    //     })

    //     await db.collection('counters').doc(id).get()

    //     await db.collection('counters').doc(id).remove()
    // }

    // {
    //     var res = await db.createCollection('fffff')
    //     console.log(res)
    // }
    // {
    //     let result = await tcb.callWxOpenApi({
    //         apiName: 'foo',
    //         event: {
    //             wxCloudApiToken: '123'
    //         }
    //     })
    //     console.log(result)
    // }



    // {
    //     let result = await tcb.getTempFileURL({
    //         fileList: ['cloud://test-e48fe1.7465-test-e48fe1/test-admin.jpeg', 'cloud://test-e48fe1.7465-test-e48fe1/my-image.png']
    //     });
    //     assert.strictEqual(result.fileList[0].fileID, 'cloud://test-e48fe1.7465-test-e48fe1/test-admin.jpeg')
    // }

    // {
    //     const fs = require("fs");

    //     let result = await tcb.uploadFile({
    //         cloudPath: "test-admin.jpeg",
    //         fileContent: fs.createReadStream(`${__dirname}/test/storage/cos.jpeg`)
    //     });

    //     console.log(result)
    // }
    // {
    //     await tcb.downloadFile({
    //         fileID: 'cloud://test-e48fe1.7465-test-e48fe1/test-admin.jpeg',
    //         tempFilePath: './test.jpeg'
    //     })

    //     await tcb.deleteFile({
    //         fileList: ['cloud://test-e48fe1.7465-test-e48fe1/test-admin.jpeg']
    //     })
    // }
})();


// (async () => {
//     const _ = db.command
//     const a = await db.collection('counters').where({
//         _id: _.regex({
//             regex: 'a'
//         }) // 正则表达式为 /^\d/，转义后变成 '^\\d'
//     }).get()

//     const c = await db.collection('counters').where({
//         _id: /.*/
//     }).skip(0).limit(10).get()
// })()